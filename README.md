# BrooksQuant

基于 **Al Brooks 价格行为理论** 的 Binance 永续合约量化交易系统。

## 概述

BrooksQuant 是一个全自动化的量化交易系统，实现了 Al Brooks 价格行为交易策略。系统支持观察模式（模拟交易）和实盘模式，具备完整的风险管理、订单流分析和多时间框架过滤功能。

### 核心特性

- **Al Brooks 策略**：Spike、H2/L2、Failed Breakout、Wedge、Climax 等经典形态
- **订单流分析**：基于 aggTrade 的 Delta 分析，识别吸收、突破、流动性撤离
- **双止损保护**：软止损（程序监控）+ 硬止损（交易所挂单）双重保障
- **HTF 过滤器**：高时间框架趋势过滤，避免逆势交易
- **多周期自适应**：根据 K 线周期自动调整策略参数
- **智能止盈**：分批止盈（TP1/TP2）+ 追踪止损 + 动态保本
- **实盘对齐**：启动恢复 + 60 秒定期校准，确保与交易所同步
- **实际盈亏**：查询币安真实成交价和手续费，准确计算盈亏

## 系统架构

```
BrooksQuant/
├── main.py                 # 主入口，启动所有异步任务
├── strategy.py             # 策略核心，信号生成（决策层）
├── order_executor.py       # 订单执行，处理开平仓请求
├── trade_logger.py         # 交易日志，内存 + Redis 持久化
├── user_manager.py         # 用户管理，Binance API 封装
├── delta_flow.py           # 订单流分析（Delta）
├── config.py               # 配置管理
│
├── workers/                # 异步工作者
│   ├── kline_producer.py   # K线数据流生产者
│   ├── user_worker.py      # 用户信号处理 + 持仓同步
│   ├── stats_worker.py     # 统计打印
│   └── helpers.py          # 辅助函数
│
├── logic/                  # 策略逻辑
│   ├── patterns.py         # 形态检测（Spike/Wedge/Climax）
│   ├── state_machines.py   # H2/L2 状态机
│   ├── market_analyzer.py  # 市场状态分析
│   ├── htf_filter.py       # 高时间框架过滤器
│   ├── interval_params.py  # 周期自适应参数
│   ├── signal_h2l2.py      # H2/L2 信号处理
│   ├── signal_checks.py    # 信号检测器
│   ├── signal_tp.py        # 止盈计算
│   ├── signal_recorder.py  # 信号记录
│   ├── trader_equation.py  # 交易者方程
│   ├── talib_indicators.py # TA-Lib 指标计算
│   └── talib_patterns.py   # TA-Lib 形态识别
│
├── .env                    # 环境变量配置
├── brooksquant.service     # Systemd 服务文件
└── requirements.txt        # Python 依赖
```

### 模块关系图

```
┌─────────────────────────────────────────────────────────────────┐
│  main.py（主入口）                                               │
│  - 启动所有异步任务                                              │
│  - 协调各模块生命周期                                            │
└───────────────────┬─────────────────────────────────────────────┘
                    │
        ┌───────────┼───────────┬───────────────┐
        ▼           ▼           ▼               ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│ kline_    │ │ aggtrade_ │ │ user_     │ │ stats_    │
│ producer  │ │ worker    │ │ worker    │ │ worker    │
│ (K线数据) │ │ (Delta流) │ │ (订单执行)│ │ (统计)    │
└─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └───────────┘
      │             │             │
      ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────┐
│  strategy.py（决策层）                                           │
│  - 信号生成                                                      │
│  - HTF/Delta 过滤                                               │
│  - 止盈止损计算                                                  │
└─────────────────────────────────────────────────────────────────┘
                    │
        ┌───────────┼───────────┬───────────────┐
        ▼           ▼           ▼               ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│ patterns  │ │ htf_      │ │ delta_    │ │ market_   │
│ (形态)    │ │ filter    │ │ flow      │ │ analyzer  │
└───────────┘ └───────────┘ └───────────┘ └───────────┘
```

---

## 交易场景与逻辑

### 完整交易流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           BrooksQuant 交易流程                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 数据采集                                                                │
│     ├─ kline_producer: 订阅 Binance K线 WebSocket                           │
│     └─ aggtrade_worker: 订阅 aggTrade 计算 Delta                            │
│                              │                                              │
│                              ▼                                              │
│  2. 信号生成（strategy.py）                                                 │
│     ├─ 市场状态识别: StrongTrend/Channel/TradingRange/Breakout              │
│     ├─ 形态检测: Spike/H2/L2/Wedge/Climax/MTR/FinalFlag                     │
│     ├─ HTF 过滤: 1h EMA20 趋势方向                                          │
│     ├─ Delta 过滤: 订单流确认                                               │
│     └─ 交易者方程: WinRate × Reward > Risk                                  │
│                              │                                              │
│                              ▼                                              │
│  3. 信号广播                                                                │
│     └─ kline_producer → user_queues（每用户一个队列）                        │
│                              │                                              │
│                              ▼                                              │
│  4. 订单执行（user_worker + order_executor）                                │
│     ├─ 检查冷却期/反手条件                                                  │
│     ├─ 计算仓位大小                                                         │
│     ├─ 开仓（市价/限价）                                                    │
│     ├─ 挂硬止损单（交易所保护）                                              │
│     └─ 挂 TP1 止盈单                                                        │
│                              │                                              │
│                              ▼                                              │
│  5. 持仓管理                                                                │
│     ├─ K线收盘检查软止损                                                    │
│     ├─ TP1 触发 → 平仓 50% + 止损移至保本                                   │
│     ├─ 追踪止损（盈利 ≥ 1R 激活）                                           │
│     └─ TP2/SL 触发 → 全部平仓                                               │
│                              │                                              │
│                              ▼                                              │
│  6. 持仓同步（60秒校准）                                                    │
│     ├─ 对比币安真实持仓 vs 本地状态                                          │
│     ├─ 检测外部平仓（手动/强平）                                             │
│     └─ 恢复孤儿持仓                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 信号类型详解

| 信号 | 类型 | 市场状态 | 入场方式 | 说明 |
|------|------|---------|---------|------|
| **Spike** | 突破型 | Breakout | 市价单 | 强势突破，实体 > 1.8倍平均，顺势入场 |
| **H2** | 回撤型 | Channel/Trend | 限价单 | 上升趋势中第二次回调做多 |
| **L2** | 回撤型 | Channel/Trend | 限价单 | 下降趋势中第二次回调做空 |
| **Failed_Breakout** | 反转型 | TradingRange | 限价单 | 假突破后反转 |
| **Wedge** | 反转型 | TradingRange | 限价单 | 楔形三推反转 |
| **Climax** | 反转型 | Any | 市价单 | 高潮竭尽反转 |
| **MTR** | 反转型 | StrongTrend→ | 限价单 | 主要趋势反转（突破 EMA + 回测） |
| **FinalFlag** | 反转型 | TightChannel | 限价单 | 终极旗形反转 |

### 形态优先级（Al Brooks 理念）

系统严格遵循 Al Brooks 的形态优先级原则：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Al Brooks 形态检测优先级                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  优先级 1: Climax 反转                                                      │
│           └─ "极端信号需要立即响应，错过就没了"                              │
│                                                                             │
│  优先级 2: Strong Spike                                                     │
│           └─ "强突破后应该 Always In，站在趋势一边"                          │
│                                                                             │
│  优先级 3: H2/L2 顺势二次入场                                               │
│           └─ "大多数交易日我只做 H2 买入或 L2 卖出"                          │
│           └─ 条件：非 Spike 周期 + HTF 过滤通过                             │
│                                                                             │
│  优先级 4: Failed Breakout                                                  │
│           └─ "假突破在区间边界最有效"                                        │
│           └─ 条件：仅在 TradingRange 状态触发                               │
│                                                                             │
│  优先级 5: Wedge 反转                                                       │
│           └─ "楔形三推是经典反转形态"                                        │
│           └─ 条件：非 Spike 周期                                            │
│                                                                             │
│  优先级 6: MTR 主要趋势反转                                                 │
│           └─ "MTR 需要多重确认"                                             │
│           └─ 条件：非 Spike 周期                                            │
│                                                                             │
│  优先级 7: Final Flag Reversal                                              │
│           └─ "趋势耗尽的最后挣扎"                                            │
│           └─ 条件：仅在 Final Flag 状态触发                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**优先级设计原则：**
1. **极端信号优先**：Climax 是市场极端情绪，需要立即响应
2. **顺势优先于反转**：Spike → H2/L2 → 反转信号
3. **二次入场是主力**：H2/L2 是最常用、最可靠的入场方式
4. **反转信号需要更多确认**：限制触发条件（TradingRange/非 Spike 周期）
5. **Spike 周期保护**：趋势确立后禁止反转信号，避免逆势交易

### H2/L2 状态机逻辑

```
H2（上升趋势回调做多）状态机：

  WAIT_FOR_TREND          # 等待上升趋势确立
        │
        ▼ (价格 > EMA20 且 EMA 上升)
  WAIT_FOR_PULLBACK_1     # 等待第一次回调
        │
        ▼ (低点低于前低)
  WAIT_FOR_HIGHER_HIGH_1  # 等待更高的高点
        │
        ▼ (高点高于前高)
  WAIT_FOR_PULLBACK_2     # 等待第二次回调（H1 完成）
        │
        ▼ (低点低于前低)
  SIGNAL_READY            # H2 信号就绪，等待信号棒确认
        │
        ▼ (信号棒质量合格 + Delta 确认)
  SIGNAL_GENERATED        # 生成买入信号
```

### 市场状态过滤规则

```python
# 市场状态 vs 允许的信号

SIGNAL_RULES = {
    "StrongTrend": {
        "allowed": ["顺势 Spike", "顺势 H2/L2"],
        "blocked": ["所有反转信号"],
        "reason": "强趋势中反转胜率极低"
    },
    "TightChannel": {
        "allowed": ["顺势信号"],
        "blocked": ["反转信号"],
        "reason": "紧密通道突破前不宜反转"
    },
    "Channel": {
        "allowed": ["全部"],
        "blocked": [],
        "reason": "正常通道，双向交易"
    },
    "TradingRange": {
        "allowed": ["反转信号优先", "Spike（突破）"],
        "blocked": [],
        "reason": "震荡区间适合做反转"
    },
    "Breakout": {
        "allowed": ["顺势 Spike"],
        "blocked": ["反转信号"],
        "reason": "突破后顺势"
    }
}
```

### Delta 订单流过滤逻辑

```
Delta 计算：
  买方 Delta = 主动买入成交量（吃卖单）
  卖方 Delta = 主动卖出成交量（吃买单）
  累计 Delta = 买方 Delta - 卖方 Delta

过滤规则：
┌─────────────────┬─────────────────────────────────────────────┐
│ Delta 趋势       │ 对信号的影响                                 │
├─────────────────┼─────────────────────────────────────────────┤
│ STRONG_BULLISH  │ 买入信号 +20% 权重，卖出信号阻止             │
│ BULLISH         │ 买入信号 +10% 权重                           │
│ NEUTRAL         │ 无影响                                       │
│ BEARISH         │ 卖出信号 +10% 权重                           │
│ STRONG_BEARISH  │ 卖出信号 +20% 权重，买入信号阻止             │
└─────────────────┴─────────────────────────────────────────────┘

异常检测：
  - 吸收（Absorption）: 大量买入但价格不涨 → 隐藏卖家在出货
  - Climax: 极端成交量 + 单边 Delta → 可能反转
  - 流动性撤离: 价格变化但成交量萎缩 → 假突破
```

### HTF 趋势过滤

```
┌─────────────────────────────────────────────────────────────────┐
│                    1小时 EMA20 趋势过滤                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  计算方式:                                                      │
│    slope = (EMA_current - EMA_previous) / EMA_previous × 100    │
│                                                                 │
│  趋势判断:                                                      │
│    slope > +0.05%  →  Bullish（看涨）                           │
│    slope < -0.05%  →  Bearish（看跌）                           │
│    其他           →  Neutral（中性）                            │
│                                                                 │
│  硬过滤（强制阻止）:                                             │
│    HTF = Bullish  → 禁止 L2（做空）信号                         │
│    HTF = Bearish  → 禁止 H2（做多）信号                         │
│                                                                 │
│  软过滤（权重调整）:                                             │
│    顺势信号  → 权重 ×1.2                                        │
│    逆势信号  → 权重 ×0.7                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 持仓同步机制（三位一体）

为保证 100% 准确性，系统按以下优先级同步：

```
┌─────────────────────────────────────────────────────────────────┐
│                    持仓同步架构                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Binance API（核心依据）                                      │
│     └─ futures_position_information → 真实仓位（量、价、侧）    │
│                                                                 │
│  2. Redis（快速缓存）                                            │
│     └─ trade:position:{user} → Trade 对象中间状态               │
│     └─ trade:aux:{user} → TP1/TP2/追踪止损状态                  │
│                                                                 │
│  3. 内存（运行时状态）                                           │
│     └─ trade_logger.positions → 当前持仓对象                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 同步流程

```python
# 1. 启动时恢复（Recovery on Startup）
async def _recover_binance_position():
    """
    程序启动时：
    1. 查询币安真实持仓
    2. 若有持仓但本地无记录 → 从币安恢复
    3. 若 Redis 有缓存且与币安一致 → 恢复完整状态（含 TP1/追踪止损）
    4. 若不一致 → 以币安为准重建
    """

# 2. 定期校准（每 60 秒）
async def _position_sync_alignment():
    """
    对比币安真实持仓与本地 trade_logger：
    
    场景 A: 币安无仓 + 本地有
      → 外部平仓（手动/强平/TP2/SL 被触发）
      → 标记为 externally_closed
      → 取消所有挂单
    
    场景 B: 币安有仓 + 本地无
      → 孤儿持仓（手动开单/程序重启丢失）
      → 从币安恢复并挂 2% ATR 紧急止损
    
    场景 C: 币安有仓 + 本地有 + 数量不一致
      → 同步数量和入场价（可能是手动加仓/减仓）
    
    场景 D: 币安有仓 + 本地有 + 方向不一致
      → 强制重建（极端情况：手动反手）
    """
```

---

## 双止损策略

BrooksQuant 采用双重止损保护机制：

```
┌─────────────────────────────────────────────────────────────────┐
│                      做空示例                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  硬止损 (交易所挂单) ─────── 89,621.40  (+0.15% 缓冲)           │
│                              ▲                                  │
│                              │  缓冲区（避免滑点触发）           │
│                              ▼                                  │
│  软止损 (程序监控)   ─────── 89,487.00  (K线收盘价)             │
│                                                                 │
│  入场价             ─────── 89,304.20                           │
│                                                                 │
│  TP1 (1R, 50%)      ─────── 89,121.40                           │
│                                                                 │
│  TP2 (2R, 50%)      ─────── 88,938.60                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 止损触发逻辑

| 场景 | 触发条件 | 处理方式 |
|------|---------|---------|
| **正常情况** | K线收盘价触及软止损 | 程序执行市价平仓 → 取消硬止损挂单 |
| **极端情况** | 程序崩溃/网络断开 | 硬止损挂单自动触发保护 |
| **闪崩/插针** | 价格瞬间穿过软止损 | 硬止损兜底，限制最大损失 |

---

## 止盈止损策略

```
入场 ──────────────────────────────────────────────────────────►
  │
  │  TP1 (1R, 平仓 50%)
  │  ├─ 触发后止损移至入场价（保本）
  │  ├─ 挂 TP2 限价止盈单
  │  │
  │  TP2 (Measured Move, 平仓剩余 50%)
  │  ├─ 或追踪止损退出
  │
  ▼
止损 (市价单确保执行)
```

**追踪止损规则：**
- 激活条件：盈利 ≥ 0.8R
- 追踪距离：0.5R
- 只向有利方向移动
- 不会回退到入场价以下（TP1 后）

---

## 快速开始

### 环境要求

- Python 3.10+
- Redis 6+
- Ubuntu 20.04+

### 安装步骤

```bash
# 1. 克隆项目
git clone https://github.com/your-repo/BrooksQuant.git
cd BrooksQuant

# 2. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 填入实际配置

# 5. 启动系统
python main.py
```

### Systemd 服务部署

```bash
# 复制服务文件
sudo cp brooksquant.service /etc/systemd/system/

# 启用并启动
sudo systemctl daemon-reload
sudo systemctl enable brooksquant
sudo systemctl start brooksquant

# 查看状态
sudo systemctl status brooksquant
sudo journalctl -u brooksquant -f
```

---

## 配置说明

### 环境变量 (.env)

```bash
# ============ Redis ============
REDIS_URL=redis://localhost:6379/0

# ============ Binance API ============
USER1_API_KEY=your_api_key
USER1_API_SECRET=your_api_secret
USER2_API_KEY=your_api_key_2        # 可选
USER2_API_SECRET=your_api_secret_2  # 可选

# ============ 运行模式 ============
OBSERVE_MODE=true                    # true=观察模式, false=实盘

# ============ 交易参数 ============
SYMBOL=BTCUSDT                       # 交易对
INTERVAL=5m                          # K线周期
LEVERAGE=20                          # 杠杆倍数
POSITION_SIZE_PERCENT=100            # 仓位百分比（小资金）
LARGE_BALANCE_THRESHOLD=1000         # 大资金阈值
LARGE_BALANCE_POSITION_PCT=50        # 大资金仓位百分比

# ============ 双止损 ============
HARD_STOP_BUFFER_PCT=0.15            # 硬止损缓冲（%）
```

### 仓位管理规则

| 账户余额 | 仓位比例 | 杠杆 | 说明 |
|---------|---------|------|------|
| ≤ 1000 USDT | 100% | 20x | 小资金全仓 |
| > 1000 USDT | 50% | 20x | 大资金分散风险 |

---

## 多周期自适应参数

系统根据 K 线周期自动调整策略参数：

| 周期 | 实体比例要求 | 止损 ATR 倍数 | 信号冷却 | 说明 |
|------|-------------|--------------|---------|------|
| 1m | 70% | 2.0-4.0x | 10根 | 噪音多，严格过滤 |
| 5m | 50% | 1.5-3.0x | 3根 | 标准周期 |
| 15m | 55% | 1.3-2.8x | 4根 | 信号更可靠 |
| 1h | 50% | 1.0-2.2x | 2根 | 长周期最可靠 |

---

## 风险控制

| 机制 | 说明 |
|------|------|
| **冷却期** | 止损后等待 3 根 K 线，避免连续亏损 |
| **HTF 趋势过滤** | 只做顺势交易，逆势信号被过滤或降权 |
| **Delta 过滤** | 订单流确认，避免假突破 |
| **双止损保护** | 程序 + 交易所双重保障 |
| **动态仓位** | 根据账户余额自动调整 |
| **限价单超时** | 60 秒未成交自动取消 |
| **交易者方程** | WinRate × Reward > Risk 才执行 |
| **持仓同步** | 60 秒校准，防止本地与交易所脱节 |

---

## 日志说明

```bash
# 查看实时日志
sudo journalctl -u brooksquant -f

# 查看文件日志
tail -f /opt/BrooksQuant/logs/brooksquant_*.log
```

### 关键日志标识

| 标识 | 含义 |
|------|------|
| 🎯 | 触发交易信号 |
| ✅ | 操作成功 |
| ❌ | 操作失败 |
| 📊 | K线数据/统计 |
| 🟢 | HTF 趋势更新 |
| 📈 | 追踪止损激活 |
| ⏳ | 冷却期 |
| 🔄 | 重连/恢复 |
| ⚠️ | 警告（外部平仓/孤儿持仓） |

---

## 常见问题

### 如何切换到实盘模式？

```bash
# 修改 systemd 服务
sudo systemctl edit brooksquant --force

# 添加以下内容
[Service]
Environment=OBSERVE_MODE=false

# 重启服务
sudo systemctl daemon-reload
sudo systemctl restart brooksquant
```

### 如何添加多用户？

在 `.env` 中添加：
```bash
USER2_API_KEY=your_second_api_key
USER2_API_SECRET=your_second_api_secret
```

### 手动平仓后系统会怎样？

系统每 60 秒执行持仓校准：
1. 检测到币安无仓位但本地有记录
2. 自动标记为 `externally_closed`
3. 取消所有关联挂单（TP2/SL）
4. 日志记录：`实盘对齐: 币安已无仓位，本地持仓已标记为外部平仓`

### 程序重启后持仓会丢失吗？

不会：
1. 启动时自动查询币安真实持仓
2. 尝试从 Redis 恢复完整状态（含 TP1/追踪止损）
3. 若 Redis 无缓存，以币安为准重建并挂 1% ATR 紧急止损

---

## 许可证

MIT License

## 免责声明

本软件仅供学习和研究目的。加密货币交易具有高风险，可能导致全部本金损失。使用本系统进行实盘交易的风险由用户自行承担。作者不对任何交易损失负责。

---

**BrooksQuant** - *Trade with Price Action, Not with Emotion*
