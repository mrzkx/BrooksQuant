// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// Al Brooks 价格行为策略 - TradingView Pine Script v5
// 对应 BrooksQuant 策略：市场状态、Failed Breakout、Strong Spike、Climax、Wedge、H2/L2

//@version=5
strategy("Al Brooks PA Strategy", overlay=true, pyramiding=0, default_qty_type=strategy.percent_of_equity, default_qty_value=100,
     initial_capital=10000, commission_type=strategy.commission.percent, commission_value=0.1,
     calc_on_every_tick=false, process_orders_on_close=true)

// ============================================================================
// 输入参数
// ============================================================================
grp_ind = "指标"
ema_len = input.int(20, "EMA 周期", group=grp_ind, minval=1)
atr_len = input.int(20, "ATR 周期", group=grp_ind, minval=1)
lookback = input.int(20, "回看周期", group=grp_ind, minval=5)
short_lookback = input.int(10, "短期回看(突破/区间)", group=grp_ind, minval=5)

grp_signal = "信号"
cooldown_bars = input.int(5, "同方向信号冷却(K线)", group=grp_signal, minval=1)
min_body_ratio = input.float(0.50, "最小实体占比", group=grp_signal, minval=0.3, maxval=0.9, step=0.05)
close_position_pct = input.float(0.25, "收盘位置(顶部/底部%)", group=grp_signal, minval=0.1, maxval=0.5, step=0.05)
strong_trend_threshold = input.float(0.50, "强趋势得分阈值", group=grp_signal, minval=0.3, maxval=0.8)
slope_threshold_pct = input.float(0.008, "紧凑通道斜率阈值", group=grp_signal, minval=0.002, maxval=0.03, step=0.001)

grp_patterns = "形态开关"
use_failed_breakout = input.bool(true, "Failed Breakout", group=grp_patterns)
use_spike = input.bool(true, "Strong Spike", group=grp_patterns)
use_climax = input.bool(true, "Climax 反转", group=grp_patterns)
use_wedge = input.bool(true, "Wedge 反转", group=grp_patterns)
use_h2l2 = input.bool(true, "H2/L2 回调", group=grp_patterns)

grp_rr = "止盈止损"
tp1_r = input.float(1.0, "TP1 风险倍数", group=grp_rr, minval=0.5, step=0.1)
tp2_r = input.float(2.0, "TP2 风险倍数", group=grp_rr, minval=1.0, step=0.1)
atr_stop_min = input.float(1.5, "止损最小 ATR 倍", group=grp_rr, minval=0.5, step=0.1)
atr_stop_max = input.float(3.0, "止损最大 ATR 倍", group=grp_rr, minval=1.0, step=0.1)

// ============================================================================
// 基础指标与 K 线属性
// ============================================================================
ema = ta.ema(close, ema_len)
atr_val = ta.atr(atr_len)
body_size = math.abs(close - open)
kline_range = high - low
body_ratio = kline_range > 0 ? body_size / kline_range : 0.0
is_bullish = close > open
is_bearish = close < open
above_ema = close > ema

// 10 根平均实体与波幅
avg_body_10 = ta.sma(body_size, 10)
avg_range_10 = ta.sma(kline_range, 10)

// 短期高低点
highest_10 = ta.highest(high, short_lookback)
lowest_10 = ta.lowest(low, short_lookback)
highest_10_prev = ta.highest(high[1], short_lookback)
lowest_10_prev = ta.lowest(low[1], short_lookback)

// ============================================================================
// 市场状态 (简化版)
// ============================================================================
// 连续同向 K 线
var int consec_bull = 0
var int consec_bear = 0
if is_bullish
    consec_bull := is_bullish[1] ? consec_bull[1] + 1 : 1
    consec_bear := 0
else if is_bearish
    consec_bear := is_bearish[1] ? consec_bear[1] + 1 : 1
    consec_bull := 0
else
    consec_bull := 0
    consec_bear := 0

// EMA 穿越次数 (最近 20 根)
above_ema_int = above_ema ? 1 : 0
ema_crosses = math.sum(math.abs(above_ema_int - above_ema_int[1]), 20)

// 强趋势得分 (上/下)
up_score = 0.0
down_score = 0.0
if consec_bull >= 3
    up_score += 0.25
if consec_bull >= 5
    up_score += 0.25
higher_highs = math.sum(high > high[1] ? 1 : 0, 10)
if higher_highs >= 4
    up_score += 0.2
bars_above = math.sum(above_ema ? 1 : 0, 10)
if bars_above >= 8
    up_score += 0.15
dist_pct = (close - ema) / math.max(ema, 1e-10)
if dist_pct > 0.005
    up_score += 0.1
price_5 = close[4] > 0 ? (close - open[4]) / open[4] : 0.0
if price_5 > 0.008
    up_score += 0.15

if consec_bear >= 3
    down_score += 0.25
if consec_bear >= 5
    down_score += 0.25
lower_lows = math.sum(low < low[1] ? 1 : 0, 10)
if lower_lows >= 4
    down_score += 0.2
bars_below = 10 - bars_above
if bars_below >= 8
    down_score += 0.15
if dist_pct < -0.005
    down_score += 0.1
if price_5 < -0.008
    down_score += 0.15

trend_direction = up_score >= 0.5 and up_score > down_score ? 1 : down_score >= 0.5 and down_score > up_score ? -1 : 0
trend_strength = trend_direction == 1 ? up_score : trend_direction == -1 ? down_score : 0.0

// 紧凑通道：10 根内不碰 EMA + 斜率
first_close_10 = close[9]
slope_pct = first_close_10 > 0 ? (close - first_close_10) / first_close_10 : 0.0
all_above_ema = ta.lowest(low, 10) > ema * 0.999
all_below_ema = ta.highest(high, 10) < ema * 1.001
bull_5 = math.sum(is_bullish ? 1 : 0, 5)
bear_5 = math.sum(is_bearish ? 1 : 0, 5)
tight_channel_up = (all_above_ema or bull_5 >= 3) and (slope_pct > slope_threshold_pct)
tight_channel_dn = (all_below_ema or bear_5 >= 3) and (slope_pct < -slope_threshold_pct)

// 状态枚举: 0=Channel, 1=StrongTrend, 2=Breakout, 3=TradingRange, 4=TightChannel
strong_trend = trend_strength >= strong_trend_threshold and trend_direction != 0
trading_range = ema_crosses >= 4
breakout_bar = avg_body_10 > 0 and body_size > avg_body_10 * 1.5
breakout_up = above_ema and kline_range > 0 and (close - low) / kline_range > 0.7 and breakout_bar
breakout_dn = not above_ema and kline_range > 0 and (high - close) / kline_range > 0.7 and breakout_bar

var int market_state = 0
if strong_trend
    market_state := 1  // StrongTrend
else if tight_channel_up or tight_channel_dn
    market_state := 4  // TightChannel
else if trading_range
    market_state := 3  // TradingRange
else if breakout_up or breakout_dn
    market_state := 2  // Breakout
else
    market_state := 0  // Channel

is_strong_trend_mode = market_state == 1 or market_state == 4 or trend_strength >= 0.7
allowed_side = 0  // 0=both, 1=buy, -1=sell
if is_strong_trend_mode
    if tight_channel_up or trend_direction == 1
        allowed_side := 1
    else if tight_channel_dn or trend_direction == -1
        allowed_side := -1

// ============================================================================
// 止损计算 (Signal Bar 极值 + ATR 缓冲)
// ============================================================================
buffer_atr = atr_val * 0.15
signal_low = math.min(low[1], low[2])
signal_high = math.max(high[1], high[2])
stop_buy = signal_low - buffer_atr
stop_sell = signal_high + buffer_atr
min_dist_buy = atr_val * atr_stop_min
max_dist_buy = atr_val * atr_stop_max
min_dist_sell = atr_val * atr_stop_min
max_dist_sell = atr_val * atr_stop_max
stop_buy := math.max(stop_buy, close - max_dist_buy)
stop_buy := math.min(stop_buy, close - min_dist_buy)
stop_sell := math.min(stop_sell, close + max_dist_sell)
stop_sell := math.max(stop_sell, close + min_dist_sell)

// ============================================================================
// 信号冷却 (同方向)
// ============================================================================
var int last_buy_bar = -100
var int last_sell_bar = -100
in_cooldown_buy = bar_index - last_buy_bar < cooldown_bars
in_cooldown_sell = bar_index - last_sell_bar < cooldown_bars

// ============================================================================
// 1. Failed Breakout (仅 TR，创新高/新低后反转)
// ============================================================================
new_high = high > highest_10_prev
new_low = low < lowest_10_prev
prev_bull = close[1] > open[1]
prev_bear = close[1] < open[1]
prev_close_upper = (high[1] - low[1]) > 0 and (close[1] - low[1]) / (high[1] - low[1]) > 0.7
prev_close_lower = (high[1] - low[1]) > 0 and (high[1] - close[1]) / (high[1] - low[1]) > 0.7

fb_sell = use_failed_breakout and market_state == 3 and new_high and is_bearish and (high - close) / math.max(kline_range, 1e-10) >= 0.6
fb_sell := fb_sell and not (high[1] > highest_10_prev * 0.999 and high[2] > highest_10_prev * 0.999)
fb_sell := fb_sell and not (prev_close_upper and prev_bull)
fb_buy = use_failed_breakout and market_state == 3 and new_low and is_bullish and (close - low) / math.max(kline_range, 1e-10) >= 0.6
fb_buy := fb_buy and not (low[1] < lowest_10_prev * 1.001 and low[2] < lowest_10_prev * 1.001)
fb_buy := fb_buy and not (prev_close_lower and prev_bear)

// ============================================================================
// 2. Strong Spike (Breakout/Channel/StrongTrend, 2 根同向 + 实体>2x平均 + 破 10 高/低)
// ============================================================================
consec_two_bull = is_bullish and close[1] > open[1] and close[2] > open[2]
consec_two_bear = is_bearish and close[1] < open[1] and close[2] < open[2]
break_10_high = high > highest_10_prev
break_10_low = low < lowest_10_prev
body_ok_bull = avg_body_10 > 0 and body_size >= avg_body_10 * 2 and body_ratio > 0.7
body_ok_bear = avg_body_10 > 0 and body_size >= avg_body_10 * 2 and body_ratio > 0.7
no_climax_bull = atr_val > 0 and kline_range <= atr_val * 3.0
no_climax_bear = atr_val > 0 and kline_range <= atr_val * 3.0

spike_buy = use_spike and (market_state == 2 or market_state == 0 or market_state == 1)
spike_buy := spike_buy and above_ema and consec_two_bull and break_10_high and body_ok_bull and no_climax_bull
spike_buy := spike_buy and (allowed_side == 0 or allowed_side == 1)
spike_buy := spike_buy and (market_state != 1 or trend_direction != -1)
spike_sell = use_spike and (market_state == 2 or market_state == 0 or market_state == 1)
spike_sell := spike_sell and not above_ema and consec_two_bear and break_10_low and body_ok_bear and no_climax_bear
spike_sell := spike_sell and (allowed_side == 0 or allowed_side == -1)
spike_sell := spike_sell and (market_state != 1 or trend_direction != 1)

// ============================================================================
// 3. Climax 反转 (前一根 K 线 > 2.5 ATR，当前反转 + 尾影线)
// ============================================================================
prev_range = high[1] - low[1]
climax_bar_prev = atr_val > 0 and prev_range > atr_val * 2.5
upper_tail = high - math.max(open, close)
lower_tail = math.min(open, close) - low
climax_sell = use_climax and not is_strong_trend_mode and climax_bar_prev and close[1] > open[1]
climax_sell := climax_sell and is_bearish and close < close[1]
climax_sell := climax_sell and kline_range > 0 and (high - close) / kline_range >= 0.75
climax_sell := climax_sell and kline_range > 0 and upper_tail / kline_range >= 0.15
prior_move_up = high[1] - low[3]
climax_sell := climax_sell and atr_val > 0 and prior_move_up >= atr_val * 1.5

climax_buy = use_climax and not is_strong_trend_mode and climax_bar_prev and close[1] < open[1]
climax_buy := climax_buy and is_bullish and close > close[1]
climax_buy := climax_buy and kline_range > 0 and (close - low) / kline_range >= 0.75
climax_buy := climax_buy and kline_range > 0 and lower_tail / kline_range >= 0.15
prior_move_dn = high[3] - low[1]
climax_buy := climax_buy and atr_val > 0 and prior_move_dn >= atr_val * 1.5

// ============================================================================
// 4. Wedge 反转 (三高/三低收敛 + 第三根疲软)
// ============================================================================
pivot_high_1 = ta.pivothigh(high, 2, 2)
pivot_low_1 = ta.pivotlow(low, 2, 2)
// 简化：最近 25 根内找三个峰/谷
var float wedge_ph1 = na
var float wedge_ph2 = na
var float wedge_ph3 = na
var int wedge_ph3_bar = 0
if ta.pivothigh(high, 3, 3)
    wedge_ph3 := wedge_ph2
    wedge_ph2 := wedge_ph1
    wedge_ph1 := high[3]
    wedge_ph3_bar := bar_index - 3
wedge_sell_cond = use_wedge and not is_strong_trend_mode
wedge_sell_cond := wedge_sell_cond and not na(wedge_ph1) and not na(wedge_ph2) and not na(wedge_ph3)
wedge_sell_cond := wedge_sell_cond and wedge_ph1 < wedge_ph2 and wedge_ph2 < wedge_ph3
wedge_sell_cond := wedge_sell_cond and (wedge_ph2 - wedge_ph1) > (wedge_ph3 - wedge_ph2)
wedge_sell_cond := wedge_sell_cond and close < wedge_ph3 * 0.98
wedge_sell_cond := wedge_sell_cond and (high - close) / math.max(kline_range, 1e-10) >= 0.75

var float wedge_pl1 = na
var float wedge_pl2 = na
var float wedge_pl3 = na
if ta.pivotlow(low, 3, 3)
    wedge_pl3 := wedge_pl2
    wedge_pl2 := wedge_pl1
    wedge_pl1 := low[3]
wedge_buy_cond = use_wedge and not is_strong_trend_mode
wedge_buy_cond := wedge_buy_cond and not na(wedge_pl1) and not na(wedge_pl2) and not na(wedge_pl3)
wedge_buy_cond := wedge_buy_cond and wedge_pl1 > wedge_pl2 and wedge_pl2 > wedge_pl3
wedge_buy_cond := wedge_buy_cond and (wedge_pl1 - wedge_pl2) > (wedge_pl2 - wedge_pl3)
wedge_buy_cond := wedge_buy_cond and close > wedge_pl3 * 1.02
wedge_buy_cond := wedge_buy_cond and (close - low) / math.max(kline_range, 1e-10) >= 0.75

// ============================================================================
// 5. H2 / L2 状态机 (简化：趋势回调后二次入场)
// ============================================================================
// H2: 上升趋势中先回调(close<=ema)，再创新高 = H1，再回调后创新高 = H2
var int h2_state = 0   // 0=等回调 1=回调中 2=H1已出 3=等H2
var float h2_trend_high = na
var float h2_pullback_low = na
var float h2_h1_high = na
if close > ema
    if h2_state == 0
        h2_trend_high := na( h2_trend_high) ? high : math.max(high, h2_trend_high)
    else if h2_state == 1
        if not na(h2_trend_high) and high > h2_trend_high
            h2_state := 2
            h2_h1_high := high
    else if h2_state == 2
        if not na(h2_pullback_low) and low < h2_pullback_low
            h2_state := 0
            h2_trend_high := high
            h2_pullback_low := na
            h2_h1_high := na
        else if not na(h2_h1_high) and high > h2_h1_high
            h2_state := 0
            h2_trend_high := high
            h2_pullback_low := na
            h2_h1_high := na
    else if h2_state == 3
        if not na(h2_h1_high) and high > h2_h1_high
            h2_state := 0
            h2_trend_high := high
            h2_pullback_low := na
            h2_h1_high := na
        else if not na(h2_pullback_low) and low < h2_pullback_low
            h2_state := 0
            h2_trend_high := high
            h2_pullback_low := na
            h2_h1_high := na
else
    if h2_state == 0
        h2_state := 1
        h2_pullback_low := low
    else if h2_state == 1
        h2_pullback_low := na(h2_pullback_low) ? low : math.min(low, h2_pullback_low)
    else if h2_state == 2
        if not na(h2_pullback_low) and low < h2_pullback_low
            h2_state := 0
            h2_h1_high := na
            h2_pullback_low := na
        else
            h2_state := 3
    else if h2_state == 3
        if not na(h2_pullback_low) and low < h2_pullback_low
            h2_state := 0
            h2_h1_high := na
            h2_pullback_low := na

h2_signal = use_h2l2 and (allowed_side == 0 or allowed_side == 1) and h2_state == 3 and not na(h2_h1_high) and high > h2_h1_high
if h2_signal
    h2_state := 0
    h2_trend_high := high
    h2_pullback_low := na
    h2_h1_high := na

// L2
var int l2_state = 0
var float l2_trend_low = na
var float l2_bounce_high = na
var float l2_l1_low = na
if close < ema
    if l2_state == 0
        l2_trend_low := na(l2_trend_low) ? low : math.min(low, l2_trend_low)
    else if l2_state == 1
        if not na(l2_trend_low) and low < l2_trend_low
            l2_state := 2
            l2_l1_low := low
    else if l2_state == 2
        if not na(l2_bounce_high) and high > l2_bounce_high
            l2_state := 0
            l2_trend_low := low
            l2_bounce_high := na
            l2_l1_low := na
        else if not na(l2_l1_low) and low < l2_l1_low
            l2_state := 0
            l2_trend_low := low
            l2_bounce_high := na
            l2_l1_low := na
    else if l2_state == 3
        if not na(l2_l1_low) and low < l2_l1_low
            l2_state := 0
            l2_trend_low := low
            l2_bounce_high := na
            l2_l1_low := na
        else if not na(l2_bounce_high) and high > l2_bounce_high
            l2_state := 0
            l2_trend_low := low
            l2_bounce_high := na
            l2_l1_low := na
else
    if l2_state == 0
        l2_state := 1
        l2_bounce_high := high
    else if l2_state == 1
        l2_bounce_high := na(l2_bounce_high) ? high : math.max(high, l2_bounce_high)
    else if l2_state == 2
        if not na(l2_bounce_high) and high > l2_bounce_high
            l2_state := 0
            l2_l1_low := na
            l2_bounce_high := na
        else
            l2_state := 3
    else if l2_state == 3
        if not na(l2_bounce_high) and high > l2_bounce_high
            l2_state := 0
            l2_l1_low := na
            l2_bounce_high := na

l2_signal = use_h2l2 and (allowed_side == 0 or allowed_side == -1) and l2_state == 3 and not na(l2_l1_low) and low < l2_l1_low
if l2_signal
    l2_state := 0
    l2_trend_low := low
    l2_bounce_high := na
    l2_l1_low := na

// 信号棒质量 (H2/L2): 实体占比 + 收盘位置
valid_bar_buy = body_ratio >= min_body_ratio and is_bullish and (close - low) / math.max(kline_range, 1e-10) <= close_position_pct
valid_bar_sell = body_ratio >= min_body_ratio and is_bearish and (high - close) / math.max(kline_range, 1e-10) <= close_position_pct
h2_signal := h2_signal and valid_bar_buy
l2_signal := l2_signal and valid_bar_sell

// ============================================================================
// 合并信号与冷却
// ============================================================================
sig_buy = (fb_buy or spike_buy or climax_buy or wedge_buy_cond or h2_signal) and not in_cooldown_buy
sig_sell = (fb_sell or spike_sell or climax_sell or wedge_sell_cond or l2_signal) and not in_cooldown_sell
if sig_buy
    last_buy_bar := bar_index
if sig_sell
    last_sell_bar := bar_index

// 止损与止盈
risk_buy = close - stop_buy
risk_sell = stop_sell - close
tp1_buy = close + risk_buy * tp1_r
tp2_buy = close + risk_buy * tp2_r
tp1_sell = close - risk_sell * tp1_r
tp2_sell = close - risk_sell * tp2_r

// ============================================================================
// 策略执行 (TP1 平 50% 仓，TP2 平剩余；止损共用)
// ============================================================================
if sig_buy and strategy.position_size <= 0
    strategy.entry("Long", strategy.long)
    strategy.exit("Exit Long TP1", "Long", limit=tp1_buy, stop=stop_buy, qty_percent=50)
    strategy.exit("Exit Long TP2", "Long", limit=tp2_buy, stop=stop_buy)
if sig_sell and strategy.position_size >= 0
    strategy.entry("Short", strategy.short)
    strategy.exit("Exit Short TP1", "Short", limit=tp1_sell, stop=stop_sell, qty_percent=50)
    strategy.exit("Exit Short TP2", "Short", limit=tp2_sell, stop=stop_sell)

// ============================================================================
// 绘图
// ============================================================================
plot(ema, "EMA", color=color.new(color.blue, 0), linewidth=2)
plotshape(sig_buy, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small)
plotshape(sig_sell, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small)

// 市场状态标签
var table state_table = table.new(position.top_right, 2, 2, bgcolor=color.new(color.black, 80))
if barstate.islast
    state_str = market_state == 0 ? "Channel" : market_state == 1 ? "StrongTrend" : market_state == 2 ? "Breakout" : market_state == 3 ? "TradingRange" : "TightChannel"
    table.cell(state_table, 0, 0, "Market", text_color=color.white, text_size=size.small)
    table.cell(state_table, 1, 0, state_str, text_color=color.yellow, text_size=size.small)
    table.cell(state_table, 0, 1, "Trend", text_color=color.white, text_size=size.small)
    table.cell(state_table, 1, 1, trend_direction == 1 ? "Up" : trend_direction == -1 ? "Down" : "-", text_color=color.gray, text_size=size.small)
